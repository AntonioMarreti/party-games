<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="referrer" content="origin">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Party Games</title>
    <!-- Live version: https://lapin.live/mpg -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">

    <!-- CSS –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <link rel="stylesheet" href="libs/bootstrap.min.css">
    <link rel="stylesheet" href="libs/bootstrap-icons.css">
    <link rel="stylesheet" href="libs/animate.min.css">

    <link rel="stylesheet" href="css/variables.css?v=2320">
    <link rel="stylesheet" href="css/layout.css?v=2320">
    <link rel="stylesheet" href="css/components.css?v=2320">
    <link rel="stylesheet" href="css/modules/lobby.css?v=2320">
    <link rel="stylesheet" href="css/modules/profile.css?v=2320">
    <link rel="stylesheet" href="css/modules/room.css?v=2320">
    <link rel="stylesheet" href="css/modules/modals.css?v=2320">
    <link rel="stylesheet" href="css/modules/blokus.css?v=2320">
    <link rel="stylesheet" href="styles.css?v=2320">
    <link rel="stylesheet" href="css/dark-mode.css?v=2320">
    <script src="js/audio.js?v=2320"></script>
    <script src="js/app.js?v=2320"></script>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="libs/qrcode.min.js"></script>

</head>


<body>

    <div class="device-wrapper">
        <div class="device-content">
            <div class="container">

                <!-- Screen: Splash -->
                <div id="screen-splash" class="screen active-screen">
                    <div class="login-screen-wrap">
                        <div class="login-bg-animated"></div>
                        <div class="d-flex flex-column align-items-center justify-content-center h-100">
                            <div class="splash-logo-circle mb-4">
                                <i class="bi bi-controller"></i>
                            </div>
                            <div class="spinner-border text-light opacity-50" role="status"
                                style="width: 1.5rem; height: 1.5rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Screen: Login -->
                <div id="screen-login" class="screen">
                    <div class="login-screen-wrap">
                        <div class="login-bg-animated"></div>

                        <div class="login-card">
                            <div class="login-logo-circle">
                                <i class="bi bi-controller"></i>
                            </div>
                            <h1 class="login-title">Party Games</h1>
                            <p class="login-subtitle">–°–≤–µ—Ç, –∫–∞–º–µ—Ä–∞, –≤–µ—á–µ—Ä–∏–Ω–∫–∞! ‚ú®</p>

                            <div id="login-loading" class="spinner-border text-light mb-4" role="status"
                                style="display:none;">
                            </div>

                            <!-- Alternative Login -->
                            <button class="btn-premium-tg" onclick="loginViaBot()">
                                <i class="bi bi-robot"></i>
                                <span>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞</span>
                            </button>

                            <!-- DEV LOGIN (REMOVE IN PRODUCTION) -->
                            <div class="mt-4">
                                <div class="d-flex justify-content-center gap-2 mb-2">
                                    <button class="btn btn-sm btn-outline-light text-white-50 p-1"
                                        onclick="devLogin(1)">Dev 1</button>
                                    <button class="btn btn-sm btn-outline-light text-white-50 p-1"
                                        onclick="devLogin(2)">Dev 2</button>
                                    <button class="btn btn-sm btn-outline-light text-white-50 p-1"
                                        onclick="devLogin(3)">Dev 3</button>
                                    <button class="btn btn-sm btn-outline-light text-white-50 p-1"
                                        onclick="devLogin(4)">Dev 4</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Screen: Lobby -->
                <div id="screen-lobby" class="screen">

                    <!-- Tab: Home -->
                    <div id="tab-home" class="tab-content active-tab">
                        <div class="header-bg">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div>
                                    <div class="header-subtitle">–ì–æ—Ç–æ–≤ –∫ –≤–µ—á–µ—Ä–∏–Ω–∫–µ?</div>
                                    <div class="header-title" id="user-name-display">–ü—Ä–∏–≤–µ—Ç!</div>
                                </div>
                                <div id="lobby-user-avatar" onclick="switchTab('profile')" style="cursor: pointer;">
                                </div>
                            </div>
                        </div>

                        <div class="content-wrapper pt-4">
                            <div class="actions-grid">
                                <button class="action-card" data-bs-toggle="modal" data-bs-target="#joinModal">
                                    <i class="bi bi-qr-code-scan action-icon"></i>
                                    <div class="action-title">–í–æ–π—Ç–∏</div>
                                    <div class="action-desc">–í –∫–æ–º–Ω–∞—Ç—É<br>–ø–æ –∫–æ–¥—É</div>
                                </button>
                                <button class="action-card" data-bs-toggle="modal" data-bs-target="#createModal">
                                    <i class="bi bi-controller action-icon"></i>
                                    <div class="action-title">–°–æ–∑–¥–∞—Ç—å</div>
                                    <div class="action-desc">–ù–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</div>
                                </button>
                            </div>

                            <div class="section-title mt-4">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–≥—Ä—ã</div>
                            <div class="horizontal-scroll" id="popular-games-list">
                                <!-- Dynamically loaded via app.js -->
                                <div class="text-center w-100 opacity-50 py-3">
                                    <div class="spinner-border spinner-border-sm"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –¢–ê–ë 2: –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ò –ü–û–ò–°–ö -->
                    <div id="tab-games" class="tab-content" style="display: none;">
                        <div class="header-bg">
                            <div class="header-title">–ò–≥—Ä—ã</div>
                            <div class="header-subtitle">–ù–∞–π—Ç–∏ –∫–æ–º–ø–∞–Ω–∏—é</div>
                            <div class="position-relative">
                                <i class="bi bi-search position-absolute text-white"
                                    style="top: 27px; right: 15px; opacity: 0.7;"></i>
                                <input type="text" class="search-bar ps-3" placeholder="–ü–æ–∏—Å–∫ –∫–æ–º–Ω–∞—Ç...">
                            </div>
                        </div>
                        <div class="content-wrapper pt-4">

                            <div id="public-rooms-list" class="mb-4 position-relative">
                                <!-- Empty State HTML injected by JS -->
                            </div>

                            <div style="height: 100px;"></div>
                        </div>
                    </div>

                    <!-- –¢–ê–ë 3: –ü–†–û–§–ò–õ–¨ -->
                    <!-- 4. –ü–†–û–§–ò–õ–¨ (–ù–û–í–´–ô –î–ò–ó–ê–ô–ù) -->
                    <!-- –¢–ê–ë 3: –ü–†–û–§–ò–õ–¨ -->
                    <div id="tab-profile" class="tab-content" style="display: none;">
                        <!-- Modern Header -->
                        <div class="profile-header-modern" style="padding-top: 60px;"> <!-- Added padding for notch -->
                            <div class="profile-avatar-xl" id="profile-avatar-big">
                                <div class="profile-level-badge-float" id="profile-level-badge">1</div>
                            </div>
                            <h2 class="fw-bold mb-0" id="profile-name-big">...</h2>
                            <div class="small opacity-75 mt-1" id="profile-xp-text">0 XP</div>
                        </div>

                        <!-- Modern Stats Card (Overlapping) & Clickable -->
                        <div class="stats-card-modern" onclick="openDetailedStatsModal()" style="cursor: pointer;">
                            <div class="stat-box">
                                <div class="value" id="profile-stat-achievements">0</div>
                                <div class="label">–ê—á–∏–≤–æ–∫</div>
                            </div>
                            <div class="stat-divider-v"></div>
                            <div class="stat-box">
                                <div class="value" id="profile-stat-wins">0</div>
                                <div class="label">–ü–æ–±–µ–¥</div>
                            </div>
                            <div class="stat-divider-v"></div>
                            <div class="stat-box">
                                <div class="value" id="profile-stat-xp">0</div>
                                <div class="label">XP</div>
                            </div>
                        </div>

                        <div class="content-wrapper">


                            <!-- Detailed Stats Modal -->
                            <!-- Detailed Stats Modal REMOVED (Moved to root) -->

                            <!-- Menu Actions (Grouped Glass Style) -->
                            <div class="settings-group mb-3">
                                <!-- Edit Profile -->
                                <div class="settings-item clickable" onclick="openProfileEditor()">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-wrap text-primary me-3" style="width:32px; text-align:center;">
                                            <i class="bi bi-pencil-square fs-5"></i>
                                        </div>
                                        <span class="fw-bold text-dark">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</span>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted opacity-50 pe-2"></i>
                                </div>

                                <!-- Friends -->
                                <div class="settings-item clickable" onclick="openFriendsScreen()">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-wrap text-success me-3" style="width:32px; text-align:center;">
                                            <i class="bi bi-people-fill fs-5"></i>
                                        </div>
                                        <span class="fw-bold text-dark">–î—Ä—É–∑—å—è</span>
                                        <span id="friends-count-badge" class="badge bg-danger rounded-pill ms-2"
                                            style="display:none;">0</span>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted opacity-50 pe-2"></i>
                                </div>

                                <!-- Settings -->
                                <div class="settings-item clickable" onclick="openSettingsScreen()">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-wrap text-dark me-3" style="width:32px; text-align:center;"><i
                                                class="bi bi-gear-fill fs-5"></i></div>
                                        <span class="fw-bold text-dark">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted opacity-50 pe-2"></i>
                                </div>
                            </div>

                            <!-- Logout Group -->
                            <div class="settings-group mb-3" id="logout-menu-item-group" style="display:none;">
                                <div class="settings-item clickable" onclick="logout()">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-wrap text-danger me-3" style="width:32px; text-align:center;">
                                            <i class="bi bi-box-arrow-left fs-5"></i>
                                        </div>
                                        <span class="fw-bold text-danger">–í—ã–π—Ç–∏</span>
                                    </div>
                                </div>
                            </div>

                            <div style="height: 100px;"></div>
                        </div>
                    </div>
                </div>


                <!-- Screen: Leaderboard -->
                <div id="screen-leaderboard" class="screen">
                    <!-- Removed wrapper to fix padding -->
                    <div class="header-bg">
                        <div class="header-title">–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</div>
                        <div class="header-subtitle">–õ—É—á—à–∏–µ –∏–∑ –ª—É—á—à–∏—Ö</div>
                    </div>

                    <div class="content-wrapper pt-4">
                        <!-- Tabs -->
                        <ul class="nav nav-pills nav-fill mb-3 bg-white rounded-pill p-1 shadow-sm mx-3">
                            <li class="nav-item">
                                <a class="nav-link active rounded-pill" id="btn-lb-global" data-bs-toggle="pill"
                                    href="#tab-lb-global" onclick="loadLeaderboardList('global')">–ì–ª–æ–±–∞–ª—å–Ω—ã–π</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link rounded-pill" id="btn-lb-friends" data-bs-toggle="pill"
                                    href="#tab-lb-friends" onclick="loadLeaderboardList('friends')">–î—Ä—É–∑—å—è</a>
                            </li>
                        </ul>

                        <!-- Leaderboard List -->
                        <div id="leaderboard-screen-container" class="px-3 pb-5">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary spinner-border-sm"></div>
                            </div>
                        </div>
                        <div style="height: 100px;"></div>
                    </div>
                </div>

                <!-- 3. –≠–ö–†–ê–ù –ö–û–ú–ù–ê–¢–´ -->
                <div id="screen-room" class="screen">
                    <div class="room-content-wrapper">

                        <!-- –®–∞–ø–∫–∞ –∫–æ–º–Ω–∞—Ç—ã —Å –º–µ–Ω—é -->
                        <div class="d-flex justify-content-center mb-3 position-relative">
                            <div class="dropdown">
                                <button class="btn room-header-dropdown-btn" type="button" data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                    –ö–æ–º–Ω–∞—Ç–∞ <i class="bi bi-chevron-down ms-1"
                                        style="font-size: 10px; opacity: 0.6;"></i>
                                </button>
                                <ul class="dropdown-menu border-0 shadow-lg rounded-4 p-2 mt-2"
                                    style="min-width: 200px;">
                                    <li>
                                        <button
                                            class="dropdown-item text-danger fw-bold rounded-3 py-2 d-flex align-items-center justify-content-center"
                                            onclick="leaveRoom()">
                                            <i class="bi bi-box-arrow-right me-2"></i> –í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
                                        </button>
                                    </li>
                                </ul>
                            </div>

                            <!-- Desktop Exit Button (Hidden on Mobile) -->
                            <button class="btn btn-danger-soft desktop-room-exit-btn ms-2" onclick="leaveRoom()"
                                style="display: none;">
                                <i class="bi bi-box-arrow-right me-2"></i> –í—ã–π—Ç–∏
                            </button>
                        </div>

                        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –∫–æ–¥–æ–º -->
                        <div class="room-code-card">
                            <!-- –î–û–ë–ê–í–ò–õ–ò onclick –∏ style="cursor: pointer" -->
                            <div class="room-code-text" id="room-code-display" onclick="openQrModal()"
                                style="cursor: pointer;" title="–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å QR">
                                ...
                            </div>

                            <button class="btn-share-code" onclick="openQrModal()">
                                <i class="bi bi-share-fill"></i>
                            </button>
                        </div>

                        <!-- –ò–≥—Ä–æ–∫–∏ -->
                        <h6 class="text-start fw-bold mb-3 px-1" style="font-size: 14px;">–ò–≥—Ä–æ–∫–∏ (<span
                                id="players-count">0</span>)
                        </h6>
                        <div class="players-grid" id="players-list"></div>

                        <!-- –í—ã–±–æ—Ä –∏–≥—Ä—ã (—Ç–æ–ª—å–∫–æ –•–æ—Å—Ç) -->
                        <div id="host-controls" style="display:none; width: 100%; margin-top: auto;">
                            <div class="game-setting-card" data-bs-toggle="modal" data-bs-target="#gameSelectorModal">
                                <div class="d-flex align-items-center">
                                    <div class="game-setting-icon" id="selected-game-icon-bg"><i
                                            class="bi bi-lightning-fill" id="selected-game-icon"></i></div>
                                    <div>
                                        <div style="font-size: 12px; color: #888;">–í—ã–±—Ä–∞—Ç—å –∏–≥—Ä—É</div>
                                        <div style="font-weight: 700; font-size: 16px;" id="selected-game-name">...
                                        </div>
                                    </div>
                                </div>
                                <i class="bi bi-chevron-right text-muted"></i>
                            </div>
                            <button class="btn-start-floating" id="btn-start-game">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                        </div>

                        <!-- –û–∂–∏–¥–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –ì–æ—Å—Ç—å) -->
                        <div id="guest-waiting-msg" class="text-center text-muted w-100"
                            style="margin-top: auto; display: none;">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <p>–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</p>
                            <button class="btn btn-sm btn-link text-danger text-decoration-none"
                                onclick="leaveRoom()">–ü–æ–∫–∏–Ω—É—Ç—å
                                –∫–æ–º–Ω–∞—Ç—É</button>
                        </div>
                    </div>
                </div>

                <!-- 4. –≠–ö–†–ê–ù –ò–ì–†–´ (–û—á–∏—â–µ–Ω–Ω—ã–π) -->
                <div id="screen-game" class="screen">
                    <!-- –ú—ã —É–±—Ä–∞–ª–∏ –æ—Ç—Å—é–¥–∞ content-wrapper –∏ —à–∞–ø–∫—É. 
             –¢–µ–ø–µ—Ä—å –∏–≥—Ä–∞ (whoami.js) —Å–∞–º–∞ —Å—Ç—Ä–æ–∏—Ç —Å–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω -->
                    <div id="game-area"></div>

                    <!-- LEGACY SCORE CARD REMOVED -->
                    <div id="game-host-controls" class="fixed-bottom p-3 bg-white border-top rounded-top-4 shadow-lg"
                        style="display:none; z-index: 2000;"></div>
                </div>

                <div id="screen-profile-edit" class="screen">
                    <div class="room-content-wrapper">
                        <div class="d-flex align-items-center mb-4">
                            <button class="btn-back me-3" onclick="closeProfileEditor()">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <h4 class="fw-bold m-0">–†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ—Ñ–∏–ª—è</h4>
                        </div>

                        <div class="d-flex justify-content-center mb-4" id="avatar-preview-area">
                            <!-- Preview injected here -->
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">–ò–º—è</label>
                            <input type="text" class="form-control rounded-4 py-3 bg-light border-0"
                                id="profile-name-input" placeholder="–í–∞—à–µ –∏–º—è">
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</label>
                            <div class="d-flex gap-3 mb-3">
                                <input type="text" class="form-control rounded-4 py-3 bg-light border-0 text-center"
                                    id="emoji-input" placeholder="üòé" maxlength="2"
                                    style="font-size: 32px; width: 80px; flex-shrink: 0;">
                                <button class="btn btn-light rounded-4 py-3 flex-grow-1 fw-bold"
                                    onclick="document.getElementById('avatar-file-input').click()">
                                    <i class="bi bi-image me-2"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                                </button>
                                <input type="file" id="avatar-file-input" accept="image/*" style="display: none;"
                                    onchange="handleAvatarUpload(event)">
                            </div>
                            <label class="form-label fw-bold">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                            <div class="color-grid bg-light rounded-4" id="color-grid"></div>
                        </div>

                        <button class="btn btn-primary w-100 py-3 rounded-4 fw-bold mt-2"
                            style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%); border: none;"
                            onclick="saveProfile()">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button class="btn btn-link w-100 mt-2 text-muted text-decoration-none"
                            onclick="pendingAvatar=null; updatePreview();">
                            –°–±—Ä–æ—Å–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
                        </button>
                    </div>
                </div>

                <!-- 6. –≠–ö–†–ê–ù –î–†–£–ó–ï–ô (–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π) -->
                <div id="screen-friends" class="screen">
                    <div class="friends-view-wrapper">
                        <div class="d-flex align-items-center mb-4">
                            <button class="btn-back me-3" onclick="closeFriendsScreen()">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <h4 class="fw-bold m-0">–î—Ä—É–∑—å—è</h4>
                        </div>

                        <!-- Tabs -->
                        <div class="nav nav-pills nav-fill mb-3 bg-light rounded-pill p-1">
                            <div class="nav-item" style="cursor:pointer">
                                <a class="nav-link active rounded-pill" id="btn-friends-my"
                                    onclick="switchFriendsTab('my')">–ú–æ–∏</a>
                            </div>
                            <div class="nav-item" style="cursor:pointer">
                                <a class="nav-link rounded-pill" id="btn-friends-requests"
                                    onclick="switchFriendsTab('requests')">–ó–∞—è–≤–∫–∏ <span id="friends-req-count"
                                        class="badge bg-danger rounded-circle" style="display:none;">0</span></a>
                            </div>
                        </div>

                        <!-- Custom Tabs Content -->
                        <div class="friends-tab-content w-100">
                            <!-- My Friends Tab -->
                            <div id="tab-friends-my" class="friends-tab-pane active w-100" style="display: block;">
                                <!-- Search -->
                                <div class="input-group mb-3"
                                    style="box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 16px;">
                                    <input type="text" id="friends-search-input" class="form-control bg-light border-0"
                                        placeholder="üîç –ù–∞–π—Ç–∏ –¥—Ä—É–≥–∞ –ø–æ –∏–º–µ–Ω–∏..."
                                        style="border-top-left-radius: 16px; border-bottom-left-radius: 16px; padding: 12px;"
                                        oninput="debounceSearchFriends()">
                                    <button class="btn btn-primary" onclick="searchFriendsAction()"
                                        style="border-top-right-radius: 16px; border-bottom-right-radius: 16px; padding-left: 20px; padding-right: 20px;">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>

                                <!-- Search Results -->
                                <div id="friends-search-results" class="mb-3" style="display:none;">
                                    <h6 class="text-muted small">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h6>
                                    <div id="friends-search-list"></div>
                                    <hr>
                                </div>

                                <!-- Friends List -->
                                <div id="friends-list-container">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary spinner-border-sm"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Requests Tab -->
                            <div id="tab-friends-requests" class="friends-tab-pane w-100" style="display: none;">
                                <div id="friends-req-container">
                                    <p class="text-center text-muted m-0 p-0">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- 8. –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ï–ö (REDESIGNED) -->
                <div id="screen-settings" class="screen">
                    <div class="room-content-wrapper">
                        <div class="d-flex align-items-center mb-4">
                            <button class="btn-back me-3" onclick="closeSettingsScreen()">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <h4 class="fw-bold m-0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
                        </div>

                        <!-- 1. PERSONALIZATION CARD -->
                        <div class="settings-group mb-4 p-3">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h6 class="fw-bold m-0 text-uppercase text-muted small"><i
                                        class="bi bi-palette me-2"></i>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h6>
                            </div>

                            <!-- Accent Color (Prominent) -->
                            <div class="mb-4">
                                <div class="fw-bold mb-2" style="font-size: 15px;">–¶–≤–µ—Ç–æ–≤–æ–π –∞–∫—Ü–µ–Ω—Ç</div>
                                <div class="d-flex gap-3 justify-content-between px-1">
                                    <div class="color-option-btn selected" style="background: #6C5CE7;"
                                        onclick="applyAccentColor('#6C5CE7'); highlightColorBtn(this);"></div>
                                    <div class="color-option-btn" style="background: #0984e3;"
                                        onclick="applyAccentColor('#0984e3'); highlightColorBtn(this);"></div>
                                    <div class="color-option-btn" style="background: #fdcb6e;"
                                        onclick="applyAccentColor('#fdcb6e'); highlightColorBtn(this);"></div>
                                    <div class="color-option-btn" style="background: #00b894;"
                                        onclick="applyAccentColor('#00b894'); highlightColorBtn(this);"></div>
                                    <div class="color-option-btn" style="background: #e17055;"
                                        onclick="applyAccentColor('#e17055'); highlightColorBtn(this);"></div>
                                </div>
                            </div>

                            <!-- Visual Toggles -->
                            <!-- Dark Mode Toggle -->
                            <div class="settings-item">
                                <div class="settings-label-wrap">
                                    <div class="fw-bold">–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</div>
                                    <div class="text-muted small">–í—Å–µ–≥–¥–∞ —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω</div>
                                </div>
                                <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                    <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                        id="setting-darkMode" onchange="toggleSetting('darkMode', this.checked)">
                                </div>
                            </div>

                            <div class="settings-item">
                                <div class="settings-label-wrap">
                                    <div class="fw-bold">–≠–∫–æ–Ω–æ–º–Ω—ã–π —Ñ–æ–Ω</div>
                                    <div class="text-muted small">–ë–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞</div>
                                </div>
                                <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                    <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                        id="setting-simpleBg" onchange="toggleSetting('simpleBg', this.checked)">
                                </div>
                            </div>

                            <div class="settings-item border-0 pb-0">
                                <div class="settings-label-wrap">
                                    <div class="fw-bold">–ö—Ä—É–ø–Ω—ã–π —à—Ä–∏—Ñ—Ç</div>
                                    <div class="text-muted small">–î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è</div>
                                </div>
                                <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                    <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                        id="setting-largeFont" onchange="toggleSetting('largeFont', this.checked)">
                                </div>
                            </div>
                        </div>

                        <!-- 2. PERFORMANCE CARD -->
                        <div class="settings-group mb-4 p-3">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="fw-bold m-0 text-uppercase text-muted small"><i
                                        class="bi bi-lightning-charge me-2"></i>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h6>
                            </div>

                            <div class="settings-item">
                                <div class="settings-label-wrap">
                                    <div class="fw-bold">–ë–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–π</div>
                                    <div class="text-muted small">–£—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É</div>
                                </div>
                                <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                    <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                        id="setting-noAnimations"
                                        onchange="toggleSetting('noAnimations', this.checked)">
                                </div>
                            </div>

                            <div class="settings-item border-0 pb-0">
                                <div class="settings-label-wrap">
                                    <div class="fw-bold text-danger">–†–µ–∂–∏–º –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è ‚ùÑÔ∏è</div>
                                    <div class="text-muted small">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è</div>
                                </div>
                                <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                    <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                        id="setting-thermalSafe" onchange="toggleSetting('thermalSafe', this.checked)">
                                </div>
                            </div>
                        </div>

                        <!-- 3. SYSTEM CARD -->
                        <div class="settings-group mb-4 p-3">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="fw-bold m-0 text-uppercase text-muted small"><i
                                        class="bi bi-sliders me-2"></i>–°–∏—Å—Ç–µ–º–∞</h6>
                            </div>

                            <div class="settings-item">
                                <div class="settings-label-wrap">
                                    <div class="fw-bold">–í–∏–±—Ä–∞—Ü–∏—è (Haptics)</div>
                                </div>
                                <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                    <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                        id="setting-haptics" onchange="toggleSetting('haptics', this.checked)">
                                </div>
                            </div>

                            <div class="settings-item">
                                <div class="settings-label-wrap">
                                    <div class="fw-bold">–ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</div>
                                </div>
                                <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                    <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                        id="setting-soundEnabled"
                                        onchange="window.audioManager.toggle(this.checked); toggleSetting('soundEnabled', this.checked)">
                                </div>
                            </div>

                            <div class="settings-item border-0 pb-0">
                                <div class="settings-label-wrap">
                                    <div class="fw-bold">–õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
                                    <div class="text-muted small">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–µ–Ω—è –≤—Å–µ–º</div>
                                </div>
                                <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                    <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                        id="setting-privacyLeaderboard"
                                        onchange="toggleSetting('privacyLeaderboard', this.checked)">
                                </div>
                            </div>
                        </div>

                        <!-- 4. ABOUT CARD -->
                        <div class="settings-group mb-4 p-3">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="fw-bold m-0 text-uppercase text-muted small"><i
                                        class="bi bi-info-circle me-2"></i>–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h6>
                            </div>

                            <div class="settings-item">
                                <div class="settings-label-wrap">
                                    <div class="fw-bold">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                                    <div class="text-muted small">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –≤ –∏–≥—Ä—É</div>
                                </div>
                                <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                    <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                        id="setting-notificationsEnabled"
                                        onchange="toggleSetting('notificationsEnabled', this.checked)">
                                </div>
                            </div>

                            <div class="settings-item">
                                <div class="settings-label-wrap">
                                    <div class="fw-bold">–í–µ—Ä—Å–∏—è</div>
                                    <div class="text-muted small fw-bold" id="app-version-display">Build Loading...
                                    </div>
                                </div>
                            </div>

                            <div class="settings-item clickable border-0 pb-0"
                                onclick="window.open('https://github.com/antoniomarreti/party-games', '_blank')">
                                <div class="settings-label-wrap">
                                    <div class="fw-bold">Open Source</div>
                                    <div class="text-muted small">–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –Ω–∞ GitHub</div>
                                </div>
                                <div class="menu-icon-wrap" style="background: #f0f0f0; color: #333;">
                                    <i class="bi bi-github"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 7. –≠–ö–†–ê–ù –û–ë–ó–û–†–ê –ò–ì–†–´ (Robust Layered Architecture) -->
                <div id="screen-game-detail" class="screen"
                    style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; height: 100% !important; overflow: hidden !important; background: #fff; width: 100%; z-index: 1000;">

                    <!-- 7A. FIXED UI LAYER -->
                    <div class="fixed-ui-layer position-absolute w-100 h-100"
                        style="top:0; left:0; z-index: 100; pointer-events: none;">
                        <!-- Close Button -->
                        <div class="position-absolute"
                            style="top: calc(44px + env(safe-area-inset-top)); right: 20px; pointer-events: auto;">
                            <button class="btn d-flex align-items-center justify-content-center shadow-lg"
                                onclick="window.showScreen('lobby')"
                                style="width:40px; height:40px; border-radius:50%; background:rgba(0,0,0,0.5); backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px); border:1px solid rgba(255,255,255,0.4); color:white; padding: 0; flex-shrink: 0; min-width: 40px;">
                                <i class="bi bi-x-lg" style="font-size: 18px; line-height: 1;"></i>
                            </button>
                        </div>

                        <!-- Bottom Action Button (Navbar style) -->
                        <div class="position-absolute bottom-0 start-0 end-0 p-4 border-top"
                            style="background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); pointer-events: auto; padding-bottom: calc(20px + env(safe-area-inset-bottom)) !important;">
                            <button class="btn btn-primary w-100 py-3 rounded-4 fw-bold shadow-lg" id="btn-try-game-now"
                                style="border: none; font-size: 16px; background: linear-gradient(135deg, #007AFF 0%, #00C6FF 100%); letter-spacing: 0.5px;">
                                –ü–û–ü–†–û–ë–û–í–ê–¢–¨ –°–ï–ô–ß–ê–°
                            </button>
                        </div>
                    </div>

                    <div class="h-100"
                        style="overflow-y: auto; overflow-x: hidden; width: 100%; -webkit-overflow-scrolling: touch; z-index: 1;">
                        <div class="game-detail-wrapper"
                            style="background: #fff; padding-bottom: 200px; width: 100%; overflow-x: hidden;">
                            <!-- Cinematic Hero -->
                            <div class="game-detail-hero position-relative"
                                style="height: auto; aspect-ratio: 16/11; min-height: 300px; overflow:hidden; background: #000;">
                                <div id="game-detail-image-container"
                                    class="hero-image-wrap h-100 w-100 position-absolute"
                                    style="top:0; left:0; z-index:1;">
                                    <!-- Content injected via JS -->
                                </div>


                            </div>

                            <!-- Integrated App Bar (Overlap Effect) -->
                            <div class="bg-white p-4 d-flex align-items-center position-relative"
                                style="z-index: 15; border-bottom: 1px solid #f2f2f7; margin-top: -32px; border-radius: 32px 32px 0 0; box-shadow: 0 -10px 25px rgba(0,0,0,0.05);">
                                <div id="game-detail-icon-wrap" class="me-3"
                                    style="width: 72px; height: 72px; border-radius: 16px; color: #fff; font-size: 36px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.05);">
                                    <i id="game-detail-icon" class="bi"></i>
                                </div>
                                <div class="flex-grow-1 min-width-0 pe-2" style="min-width: 0;">
                                    <h3 class="fw-800 mb-0 text-dark text-truncate" id="game-detail-header-title"
                                        style="font-size: 21px; letter-spacing: -0.5px; width: 100%;">...</h3>
                                    <div class="text-muted small text-truncate"
                                        style="font-size: 13px; font-weight: 500; width: 100%;">–í–µ—á–µ—Ä–∏–Ω–∫–∏ ‚Ä¢ –¢–æ–ø –≤—ã–±–æ—Ä
                                    </div>
                                </div>
                                <button class="btn btn-primary px-4 py-2 rounded-pill fw-bold" id="btn-header-try-now"
                                    style="background: #007AFF; border: none; font-size: 14px; color: #fff;">–ò–ì–†–ê–¢–¨</button>
                            </div>

                            <!-- Content -->
                            <div class="p-4 bg-white">
                                <div class="d-flex overflow-auto pb-4 mb-4 border-bottom no-scrollbar"
                                    style="gap: 24px;">
                                    <div class="flex-shrink-0 text-center"
                                        style="min-width: 80px; border-right: 1px solid #f2f2f7; padding-right: 24px;">
                                        <div class="text-muted small mb-1"
                                            style="font-size: 10px; font-weight: 700; text-transform: uppercase;">
                                            –ò–≥—Ä–æ–∫–æ–≤
                                        </div>
                                        <div class="fw-bold text-dark" id="stat-players" style="font-size: 17px;">-
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 text-center"
                                        style="min-width: 80px; border-right: 1px solid #f2f2f7; padding-right: 24px;">
                                        <div class="text-muted small mb-1"
                                            style="font-size: 10px; font-weight: 700; text-transform: uppercase;">–í—Ä–µ–º—è
                                        </div>
                                        <div class="fw-bold text-dark" id="stat-time" style="font-size: 17px;">-</div>
                                    </div>
                                    <div class="flex-shrink-0 text-center" style="min-width: 80px;">
                                        <div class="text-muted small mb-1"
                                            style="font-size: 10px; font-weight: 700; text-transform: uppercase;">
                                            –°–ª–æ–∂–Ω–æ—Å—Ç—å
                                        </div>
                                        <div class="fw-bold text-dark" id="stat-difficulty" style="font-size: 17px;">-
                                        </div>
                                    </div>
                                </div>

                                <div id="game-detail-lore" class="text-dark mb-5"
                                    style="line-height: 1.6; font-size: 17px; font-weight: 400; color: #1c1c1e !important;">
                                </div>

                                <div class="mb-5">
                                    <h2 class="fw-bold mb-4 text-dark" style="font-size: 22px; letter-spacing: -0.5px;">
                                        –ö–∞–∫
                                        –∏–≥—Ä–∞—Ç—å?
                                    </h2>
                                    <div id="game-detail-rules" class="rules-list"></div>
                                </div>

                                <div id="game-detail-demo-area" class="mb-5"></div>
                            </div>
                        </div>
                    </div> <!-- /h-100 scroller layer -->
                </div> <!-- /screen-game-detail -->

                <!-- === –ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø === -->
                <div class="bottom-nav">
                    <button class="nav-item active" onclick="switchTab('home')"><i
                            class="bi bi-house-door-fill"></i><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
                    <button class="nav-item" onclick="switchTab('games')"><i
                            class="bi bi-grid-fill"></i><span>–ò–≥—Ä—ã</span></button>
                    <button class="nav-item" onclick="switchTab('leaderboard')"><i
                            class="bi bi-bar-chart-fill"></i><span>–¢–æ–ø</span></button>
                    <button class="nav-item" onclick="switchTab('profile')"><i
                            class="bi bi-person-fill"></i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
                </div>

                <!-- 5. –≠–ö–†–ê–ù –†–ï–î–ê–ö–¢–û–†–ê –ü–†–û–§–ò–õ–Ø (–û—Ç–¥–µ–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω) -->


            </div> <!-- /container -->
        </div> <!-- /device-content -->
    </div> <!-- /device-wrapper -->

    <!-- MOVED MODALS TO ROOT for correct z-index stacking -->
    <!-- 8. –ú–æ–¥–∞–ª–∫–∞ –ü—É–±–ª–∏—á–Ω–æ–≥–æ –ü—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal fade" id="leaderboardModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold ps-2">–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0 pt-2">
                    <ul class="nav nav-pills nav-fill mb-3 bg-light rounded-pill p-1">
                        <li class="nav-item">
                            <a class="nav-link active rounded-pill" data-bs-toggle="pill" href="#tab-lb-global"
                                onclick="loadLeaderboard('global')">–ì–ª–æ–±–∞–ª—å–Ω—ã–π</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link rounded-pill" data-bs-toggle="pill" href="#tab-lb-friends"
                                onclick="loadLeaderboard('friends')">–î—Ä—É–∑—å—è</a>
                        </li>
                    </ul>

                    <div id="leaderboard-screen-container" class="px-0">
                        <!-- leaderboard list -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 9. –ú–æ–¥–∞–ª–∫–∞ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –î—Ä—É–∑–µ–π -->
    <div class="modal fade" id="inviteFriendsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold ps-2">–ü–æ–∑–≤–∞—Ç—å –¥—Ä—É–∑–µ–π</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-2">
                    <div class="text-center mb-3">
                        <div class="invite-icon-wrapper">
                            <i class="bi bi-envelope-paper-heart-fill invite-icon"></i>
                        </div>
                        <p class="text-muted small">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–∑—å—è–º,<br>—á—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫
                            –∏–≥—Ä–µ.
                        </p>
                    </div>

                    <!-- Search -->
                    <div class="invite-search-group mb-3">
                        <div class="invite-search-icon"><i class="bi bi-search"></i></div>
                        <input type="text" id="invite-search-input" class="invite-search-input"
                            placeholder="–ü–æ–∏—Å–∫ –¥—Ä—É–≥–∞..." oninput="filterInviteList()">
                    </div>

                    <!-- List -->
                    <div id="invite-friends-list" class="mb-3 custom-scrollbar"
                        style="max-height: 300px; overflow-y: auto; overflow-x: hidden;">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer invite-modal-footer">
                    <button class="invite-send-btn link-light" onclick="sendInvites()" id="btn-send-invites" disabled>
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å (<span id="invite-count">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. –ú–æ–¥–∞–ª–∫–∞ –î–µ—Ç–∞–ª—å–Ω–æ–π –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (Moved here) -->
    <div id="modal-detailed-stats" class="custom-modal-overlay" style="display: none;">
        <div class="custom-modal-content glass-panel p-3" style="max-width: 400px; width: 90%;">
            <div class="position-relative mb-3 text-center">
                <h5 class="fw-bold mb-0 text-dark">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                <button class="btn-close position-absolute top-50 end-0 translate-middle-y"
                    onclick="closeModal('modal-detailed-stats')" style="font-size: 0.8rem;"></button>
            </div>

            <!-- Stats Grid -->
            <div class="row g-2 mb-3">
                <!-- Level (TOP) -->
                <div class="col-12">
                    <div class="p-2 bg-white bg-opacity-50 rounded-4 border border-white shadow-sm">
                        <div class="d-flex justify-content-between align-items-end mb-1">
                            <div>
                                <div class="text-muted"
                                    style="font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Level &
                                    Progress</div>
                                <div class="fw-bold fs-5 text-primary"><span id="detail-level-val">1</span> LVL</div>
                            </div>
                            <div class="text-muted" style="font-size: 11px;" id="detail-xp-range">0 / 100 XP</div>
                        </div>
                        <div class="progress" style="height: 6px; border-radius: 3px; background: rgba(0,0,0,0.05);">
                            <div id="detail-xp-progress"
                                class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                role="progressbar" style="width: 0%; border-radius: 3px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Basic Stats -->
                <div class="col-6">
                    <div class="p-2 bg-white bg-opacity-50 rounded-4 text-center border border-white shadow-sm">
                        <i class="bi bi-controller text-primary mb-1 d-block" style="font-size: 1.1rem;"></i>
                        <div class="text-muted mb-0" style="font-size: 9px; text-transform: uppercase;">Games</div>
                        <div class="fw-bold fs-6 text-dark" id="detail-total-games">0</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-2 bg-white bg-opacity-50 rounded-4 text-center border border-white shadow-sm">
                        <i class="bi bi-graph-up-arrow text-success mb-1 d-block" style="font-size: 1.1rem;"></i>
                        <div class="text-muted mb-0" style="font-size: 9px; text-transform: uppercase;">Winrate</div>
                        <div class="fw-bold fs-6 text-success" id="detail-winrate">0%</div>
                    </div>
                </div>
            </div>

            <h6 class="fw-bold mb-3 text-dark text-center" style="font-size: 14px;">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h6>
            <div id="detail-achievements-list" class="overflow-auto" style="max-height: 280px; min-height: 60px;">
                <!-- Injected via JS -->
            </div>

            <button class="btn btn-primary w-100 mt-4 rounded-pill py-3 fw-bold shadow-sm"
                onclick="closeModal('modal-detailed-stats')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- === –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê (RESTORED) === -->

    <!-- 0. –ú–æ–¥–∞–ª–∫–∞ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (Generic) -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered mx-auto" style="max-width: 340px;">
            <div class="modal-content border-0 shadow-lg"
                style="border-radius: 30px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold w-100 text-center mt-2" id="confirm-modal-title">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ</h5>
                </div>
                <div class="modal-body pt-3 pb-4 px-4 text-center">
                    <p class="text-muted mb-4" id="confirm-modal-text" style="font-size: 15px;">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary rounded-pill py-3 fw-bold shadow-sm"
                            id="confirm-modal-yes-btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                        <button class="btn btn-light rounded-pill py-2 fw-bold text-muted"
                            data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 0.1 –ú–æ–¥–∞–ª–∫–∞ –û–ø–æ–≤–µ—â–µ–Ω–∏—è (Alert) -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true" style="z-index: 1070;">
        <div class="modal-dialog modal-dialog-centered mx-auto" style="max-width: 320px;">
            <div class="modal-content border-0 shadow-lg"
                style="border-radius: 30px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);">
                <div class="modal-body p-4 text-center">
                    <div class="mb-3" id="alert-modal-icon-container">
                        <i class="bi bi-info-circle text-primary fs-1"></i>
                    </div>
                    <h5 class="fw-bold mb-2" id="alert-modal-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h5>
                    <p class="text-muted mb-4" id="alert-modal-text" style="font-size: 14px;">–°–æ–æ–±—â–µ–Ω–∏–µ</p>
                    <button class="btn btn-dark w-100 rounded-pill py-3 fw-bold" data-bs-dismiss="modal">–•–æ—Ä–æ—à–æ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 0.2 –ú–æ–¥–∞–ª–∫–∞ –ö–∞—Å—Ç–æ–º–Ω–∞—è (HTML Alert) -->
    <div class="modal fade" id="customAlertModal" tabindex="-1" aria-hidden="true" style="z-index: 1075;">
        <div class="modal-dialog modal-dialog-centered mx-auto" style="max-width: 340px;">
            <div class="modal-content border-0 shadow-lg"
                style="border-radius: 30px; background: rgba(255,255,255,0.85); backdrop-filter: blur(20px); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18);">
                <div class="modal-body p-4 text-center">
                    <div class="mb-3">
                        <i id="customAPIIcon" class="bi bi-robot text-primary"
                            style="font-size: 3rem; text-shadow: 0 4px 10px rgba(0,0,0,0.1);"></i>
                    </div>
                    <h5 class="fw-bold mb-3" id="customAPITitle" style="color: #2c3e50;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h5>
                    <div id="customAPIBody" class="mb-4"></div>
                    <button class="btn btn-dark w-100 rounded-pill py-3 fw-bold shadow-sm" data-bs-dismiss="modal"
                        style="background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. –ú–æ–¥–∞–ª–∫–∞ –í—Ö–æ–¥–∞ -->
    <div class="modal fade" id="joinModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold ps-2">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-2">
                    <form
                        onsubmit="joinRoom(); bootstrap.Modal.getInstance(document.getElementById('joinModal')).hide(); return false;">
                        <input type="text" id="join-room-code"
                            class="form-control form-control-lg text-center text-uppercase mb-3 fw-bold"
                            placeholder="A1B2"
                            style="border-radius: 16px; height: 60px; font-size: 24px; letter-spacing: 2px;">
                        <input type="password" id="join-room-pass" class="form-control mb-3"
                            placeholder="–ü–∞—Ä–æ–ª—å –∫–æ–º–Ω–∞—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="border-radius: 16px;">
                        <button type="submit" class="btn btn-primary w-100 btn-lg"
                            style="border-radius: 16px;">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. –ú–æ–¥–∞–ª–∫–∞ –°–æ–∑–¥–∞–Ω–∏—è -->
    <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold ps-2">–ù–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-2">
                    <form onsubmit="createRoom(); return false;">
                        <input type="text" id="create-room-title" class="form-control mb-3 fw-bold"
                            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" style="border-radius: 16px;">

                        <input type="password" id="create-room-pass" class="form-control mb-3"
                            placeholder="–ü–∞—Ä–æ–ª—å –∫–æ–º–Ω–∞—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="border-radius: 16px;">

                        <div class="form-check form-switch mb-3 ps-5">
                            <input class="form-check-input" type="checkbox" id="create-room-public"
                                style="transform: scale(1.3);">
                            <label class="form-check-label ms-2 fw-bold" for="create-room-public">–°–¥–µ–ª–∞—Ç—å
                                –ø—É–±–ª–∏—á–Ω–æ–π</label>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-lg"
                            style="border-radius: 16px;">–°–æ–∑–¥–∞—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. –ú–æ–¥–∞–ª–∫–∞ QR-–∫–æ–¥–∞ -->
    <div class="modal fade" id="qrInviteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 32px; padding: 20px;">
                <div class="d-flex justify-content-center mb-2">
                    <div style="width: 40px; height: 4px; background: #E0E0E0; border-radius: 2px;"></div>
                </div>
                <div class="text-center">
                    <h5 class="fw-bold mb-4" style="color: var(--text-dark);">–ö–æ–º–Ω–∞—Ç–∞ <span
                            id="modal-room-code-title">...</span></h5>
                    <div class="d-flex justify-content-center mb-3">
                        <div id="modal-qr-code" style="padding: 10px; border-radius: 20px; border: 2px solid #F0F0F0;">
                        </div>
                    </div>
                    <h2 class="fw-bold mb-4" style="font-size: 32px; color: var(--primary-color); letter-spacing: 1px;"
                        id="modal-room-code-text">...</h2>
                    <div class="d-grid gap-3">
                        <button class="btn btn-primary py-3 rounded-4 fw-bold shadow-sm"
                            style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%); border: none; font-size: 18px;"
                            onclick="copyInviteLink()">
                            <i class="bi bi-link-45deg me-2"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                        </button>
                        <button class="btn py-3 rounded-4 fw-bold shadow-sm"
                            style="background: #24A1DE; color: white; border: none; font-size: 18px;"
                            onclick="sendToTelegram()">
                            <i class="bi bi-telegram me-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç
                        </button>
                        <button class="btn py-3 rounded-4 fw-bold shadow-sm"
                            style="background: #fff; color: var(--primary-color); border: 1px solid #eee; font-size: 18px;"
                            onclick="bootstrap.Modal.getInstance(document.getElementById('qrInviteModal')).hide(); openInviteModal()">
                            <i class="bi bi-person-plus-fill me-2"></i> –ü–æ–∑–≤–∞—Ç—å –¥—Ä—É–≥–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. –ú–æ–¥–∞–ª–∫–∞ –í—ã–±–æ—Ä–∞ –∏–≥—Ä—ã -->
    <div class="modal fade" id="gameSelectorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold ps-2">–í—ã–±—Ä–∞—Ç—å –∏–≥—Ä—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="list-group list-group-flush" id="game-selector-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. –ú–æ–¥–∞–ª–∫–∞ –ü—É–±–ª–∏—á–Ω–æ–≥–æ –ü—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal fade" id="userProfileModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                <div class="modal-header border-0 pb-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center pt-0 pb-4">
                    <div id="public-profile-content">
                        <!-- JS injected content -->
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
            </div>
        </div>

        <script src="libs/bootstrap.bundle.min.js"></script>
        <script>
            // Callback for the widget
            async function onTelegramAuth(user) {
                document.getElementById('browser-login-btn').style.display = 'none';
                document.getElementById('login-loading').style.display = 'block';
                const formData = new FormData();
                formData.append('action', 'login_widget');
                formData.append('user_data', JSON.stringify(user));
                try {
                    const res = await fetch('server/api.php', { method: 'POST', body: formData }).then(r => r.json());
                    if (res.status === 'ok') {
                        localStorage.setItem('pg_token', res.token);
                        window.location.reload();
                    } else {
                        showAlert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', res.message, 'error');
                        document.getElementById('browser-login-btn').style.display = 'block';
                    }
                } catch (e) {
                    console.error(e);
                    showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', e.message, 'error');
                }
            }

            async function loginViaBot() {
                try {
                    const res = await fetch('server/api.php', {
                        method: 'POST',
                        body: new URLSearchParams({ action: 'create_auth_session' })
                    }).then(r => r.json());

                    if (res.status === 'ok') {
                        window.open(res.bot_url, '_blank');

                        // Start polling
                        const poll = setInterval(async () => {
                            const check = await fetch('server/api.php', {
                                method: 'POST',
                                body: new URLSearchParams({
                                    action: 'poll_auth_session',
                                    temp_code: res.temp_code
                                })
                            }).then(r => r.json());

                            if (check.status === 'ok') {
                                clearInterval(poll);
                                localStorage.setItem('pg_token', check.token);
                                window.location.reload();
                            }
                        }, 2000);

                        // Stop polling after 5 mins
                        setTimeout(() => clearInterval(poll), 300000);

                    } else {
                        showAlert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                    }
                } catch (e) {
                    console.error(e);
                }
            }
        </script>
</body>

</html>