<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="referrer" content="origin">
    <title>Party Games</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">

    <!-- CSS –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <link rel="stylesheet" href="libs/bootstrap.min.css">
    <link rel="stylesheet" href="libs/bootstrap-icons.css">
    <link rel="stylesheet" href="libs/animate.min.css">

    <link rel="stylesheet" href="css/layout.css?v=2118">
    <link rel="stylesheet" href="styles.css?v=2118">
    <script src="js/app.js?v=2118"></script>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="libs/qrcode.min.js"></script>

</head>


<body>

    <div class="device-wrapper">
        <div class="device-content">
            <div class="container">

                <!-- Screen: Splash -->
                <div id="screen-splash" class="screen active-screen">
                    <div class="login-screen-wrap">
                        <div class="login-bg-animated"></div>
                        <div class="d-flex flex-column align-items-center justify-content-center h-100">
                            <div class="splash-logo-circle mb-4">
                                <i class="bi bi-controller"></i>
                            </div>
                            <div class="spinner-border text-light opacity-50" role="status"
                                style="width: 1.5rem; height: 1.5rem;"></div>
                        </div>
                    </div>
                </div>

                <!-- Screen: Login -->
                <div id="screen-login" class="screen">
                    <div class="login-screen-wrap">
                        <div class="login-bg-animated"></div>

                        <div class="login-card">
                            <div class="login-logo-circle">
                                <i class="bi bi-controller"></i>
                            </div>
                            <h1 class="login-title">Party Games</h1>
                            <p class="login-subtitle">–°–≤–µ—Ç, –∫–∞–º–µ—Ä–∞, –≤–µ—á–µ—Ä–∏–Ω–∫–∞! ‚ú®</p>

                            <div id="login-loading" class="spinner-border text-light mb-4" role="status"
                                style="display:none;">
                            </div>

                            <!-- Alternative Login -->
                            <button class="btn-premium-tg" onclick="loginViaBot()">
                                <i class="bi bi-robot"></i>
                                <span>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞</span>
                            </button>

                            <!-- DEV LOGIN (REMOVE IN PRODUCTION) -->
                            <div class="mt-4">
                                <div class="d-flex justify-content-center gap-2 mb-2">
                                    <button class="btn btn-sm btn-outline-light text-white-50 p-1"
                                        onclick="devLogin(1)">Dev 1</button>
                                    <button class="btn btn-sm btn-outline-light text-white-50 p-1"
                                        onclick="devLogin(2)">Dev 2</button>
                                    <button class="btn btn-sm btn-outline-light text-white-50 p-1"
                                        onclick="devLogin(3)">Dev 3</button>
                                    <button class="btn btn-sm btn-outline-light text-white-50 p-1"
                                        onclick="devLogin(4)">Dev 4</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Screen: Lobby -->
            <div id="screen-lobby" class="screen">

                <!-- Tab: Home -->
                <div id="tab-home" class="tab-content active-tab">
                    <div class="header-bg">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div>
                                <div class="header-subtitle">–ì–æ—Ç–æ–≤ –∫ –≤–µ—á–µ—Ä–∏–Ω–∫–µ?</div>
                                <div class="header-title" id="user-name-display">–ü—Ä–∏–≤–µ—Ç!</div>
                            </div>
                            <div id="lobby-user-avatar" onclick="switchTab('profile')" style="cursor: pointer;"></div>
                        </div>
                    </div>

                    <div class="content-wrapper pt-4">
                        <div class="actions-grid">
                            <button class="action-card" data-bs-toggle="modal" data-bs-target="#joinModal">
                                <i class="bi bi-qr-code-scan action-icon"></i>
                                <div class="action-title">–í–æ–π—Ç–∏</div>
                                <div class="action-desc">–í –∫–æ–º–Ω–∞—Ç—É<br>–ø–æ –∫–æ–¥—É</div>
                            </button>
                            <button class="action-card" data-bs-toggle="modal" data-bs-target="#createModal">
                                <i class="bi bi-controller action-icon"></i>
                                <div class="action-title">–°–æ–∑–¥–∞—Ç—å</div>
                                <div class="action-desc">–ù–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</div>
                            </button>
                        </div>

                        <div class="section-title mt-4">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–≥—Ä—ã</div>
                        <div class="horizontal-scroll">
                            <div class="mini-game-card">
                                <div class="mini-icon-box" style="background:#E67E22"><i
                                        class="bi bi-shield-shaded"></i>
                                </div>
                                <div class="mini-game-title">–ë—É–Ω–∫–µ—Ä</div>
                            </div>
                            <div class="mini-game-card">
                                <div class="mini-icon-box" style="background:#9B59B6"><i
                                        class="bi bi-lightbulb-fill"></i>
                                </div>
                                <div class="mini-game-title">–ú–æ–∑–≥–æ–≤–∞—è<br>–ë–∏—Ç–≤–∞</div>
                            </div>
                            <!-- ... other games ... -->
                        </div>
                    </div>
                </div>

                <!-- –¢–ê–ë 2: –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ò –ü–û–ò–°–ö -->
                <div id="tab-games" class="tab-content" style="display: none;">
                    <div class="header-bg">
                        <div class="header-title">–ò–≥—Ä—ã</div>
                        <div class="header-subtitle">–ù–∞–π—Ç–∏ –∫–æ–º–ø–∞–Ω–∏—é</div>
                        <div class="position-relative">
                            <i class="bi bi-search position-absolute text-white"
                                style="top: 27px; right: 15px; opacity: 0.7;"></i>
                            <input type="text" class="search-bar ps-3" placeholder="–ü–æ–∏—Å–∫ –∫–æ–º–Ω–∞—Ç...">
                        </div>
                    </div>
                    <div class="content-wrapper pt-4">

                        <div id="public-rooms-list" class="mb-4 position-relative">
                            <!-- Empty State HTML injected by JS -->
                        </div>

                        <div style="height: 100px;"></div>
                    </div>
                </div>

                <!-- –¢–ê–ë 3: –ü–†–û–§–ò–õ–¨ -->
                <!-- 4. –ü–†–û–§–ò–õ–¨ (–ù–û–í–´–ô –î–ò–ó–ê–ô–ù) -->
                <div id="tab-profile" class="tab-content" style="display: none;">
                    <div class="profile-header-premium">
                        <div class="header-title pt-4">–ü—Ä–æ—Ñ–∏–ª—å</div>
                    </div>

                    <div class="content-wrapper profile-content-push">
                        <div class="profile-card-new text-center">
                            <div class="profile-avatar-overlap">
                                <div id="profile-avatar-big" class="avatar-xl-premium mx-auto"></div>
                            </div>
                            <h2 class="fw-bold mb-0 mt-2" id="profile-name-big">...</h2>
                            <div class="text-muted small">Pro Player ‚ö°</div>
                        </div>

                        <!-- Improved Stats Card -->
                        <div class="profile-stats-card-premium mt-3">
                            <div class="d-flex justify-content-around align-items-center w-100">
                                <div class="stat-item-new">
                                    <div class="stat-icon"><i class="bi bi-trophy-fill" style="color: #f1c40f;"></i>
                                    </div>
                                    <div class="stat-value" id="profile-stat-wins">0</div>
                                    <div class="stat-label">–ü–æ–±–µ–¥</div>
                                </div>
                                <div class="stat-divider-v"></div>
                                <div class="stat-item-new">
                                    <div class="stat-icon"><i class="bi bi-dpad-fill" style="color: #9b59b6;"></i>
                                    </div>
                                    <div class="stat-value" id="profile-stat-games">0</div>
                                    <div class="stat-label">–ò–≥—Ä</div>
                                </div>
                                <div class="stat-divider-v"></div>
                                <div class="stat-item-new">
                                    <div class="stat-icon"><i class="bi bi-star-fill" style="color: #3498db;"></i></div>
                                    <div class="stat-value" id="profile-stat-rating">1000</div>
                                    <div class="stat-label">–†–µ–π—Ç–∏–Ω–≥</div>
                                </div>
                            </div>
                        </div>

                        <div class="menu-card-premium mt-3">
                            <div class="menu-row" onclick="openProfileEditor()">
                                <div class="menu-icon-wrap"><i class="bi bi-pencil-fill"></i></div>
                                <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</span>
                                <i class="bi bi-chevron-right ms-auto opacity-50"></i>
                            </div>
                            <div class="menu-row" onclick="openFriendsScreen()">
                                <div class="menu-icon-wrap"><i class="bi bi-people-fill"></i></div>
                                <span>–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π</span>
                                <span id="friends-count-badge" class="badge bg-primary rounded-pill ms-2"
                                    style="display:none;">0</span>
                                <i class="bi bi-chevron-right ms-auto opacity-50"></i>
                            </div>
                            <div class="menu-row" onclick="openSettingsScreen()">
                                <div class="menu-icon-wrap"><i class="bi bi-gear-fill"></i></div>
                                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                                <i class="bi bi-chevron-right ms-auto opacity-50"></i>
                            </div>
                            <!-- LOGOUT (Web Only) inside the same card -->
                            <div id="logout-menu-item" class="menu-row text-danger border-top-0" onclick="logout()"
                                style="display: none;">
                                <div class="menu-icon-wrap text-danger"><i class="bi bi-box-arrow-left"></i></div>
                                <span>–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</span>
                                <i class="bi bi-chevron-right ms-auto opacity-50"></i>
                            </div>
                        </div>


                    </div>
                </div>
            </div>


            <!-- Screen: Leaderboard -->
            <div id="screen-leaderboard" class="screen">
                <!-- Removed wrapper to fix padding -->
                <div class="header-bg">
                    <div class="header-title">–¢–æ–ø –ò–≥—Ä–æ–∫–æ–≤</div>
                    <div class="header-subtitle">–õ—É—á—à–∏–µ –∏–∑ –ª—É—á—à–∏—Ö</div>
                </div>

                <div class="content-wrapper pt-4">
                    <!-- Tabs -->
                    <ul class="nav nav-pills nav-fill mb-3 bg-white rounded-pill p-1 shadow-sm mx-3">
                        <li class="nav-item">
                            <a class="nav-link active rounded-pill" id="btn-lb-global" data-bs-toggle="pill"
                                href="#tab-lb-global" onclick="loadLeaderboardList('global')">–ì–ª–æ–±–∞–ª—å–Ω—ã–π</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link rounded-pill" id="btn-lb-friends" data-bs-toggle="pill"
                                href="#tab-lb-friends" onclick="loadLeaderboardList('friends')">–î—Ä—É–∑—å—è</a>
                        </li>
                    </ul>

                    <!-- Leaderboard List -->
                    <div id="leaderboard-screen-container" class="px-3 pb-5">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary spinner-border-sm"></div>
                        </div>
                    </div>
                    <div style="height: 100px;"></div>
                </div>
            </div>

            <!-- 3. –≠–ö–†–ê–ù –ö–û–ú–ù–ê–¢–´ -->
            <div id="screen-room" class="screen">
                <div class="room-content-wrapper">

                    <!-- –®–∞–ø–∫–∞ –∫–æ–º–Ω–∞—Ç—ã —Å –º–µ–Ω—é -->
                    <div class="d-flex justify-content-center mb-3 position-relative">
                        <div class="dropdown">
                            <button class="btn room-header-dropdown-btn" type="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                –ö–æ–º–Ω–∞—Ç–∞ <i class="bi bi-chevron-down ms-1" style="font-size: 10px; opacity: 0.6;"></i>
                            </button>
                            <ul class="dropdown-menu border-0 shadow-lg rounded-4 p-2 mt-2" style="min-width: 200px;">
                                <li>
                                    <button
                                        class="dropdown-item text-danger fw-bold rounded-3 py-2 d-flex align-items-center justify-content-center"
                                        onclick="leaveRoom()">
                                        <i class="bi bi-box-arrow-right me-2"></i> –í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –∫–æ–¥–æ–º -->
                    <div class="room-code-card">
                        <!-- –î–û–ë–ê–í–ò–õ–ò onclick –∏ style="cursor: pointer" -->
                        <div class="room-code-text" id="room-code-display" onclick="openQrModal()"
                            style="cursor: pointer;" title="–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å QR">
                            ...
                        </div>

                        <button class="btn-share-code" onclick="openQrModal()">
                            <i class="bi bi-share-fill"></i>
                        </button>
                    </div>

                    <!-- –ò–≥—Ä–æ–∫–∏ -->
                    <h6 class="text-start fw-bold mb-3 px-1" style="font-size: 14px;">–ò–≥—Ä–æ–∫–∏ (<span
                            id="players-count">0</span>)
                    </h6>
                    <div class="players-grid" id="players-list"></div>

                    <!-- –í—ã–±–æ—Ä –∏–≥—Ä—ã (—Ç–æ–ª—å–∫–æ –•–æ—Å—Ç) -->
                    <div id="host-controls" style="display:none; width: 100%; margin-top: auto;">
                        <div class="game-setting-card" data-bs-toggle="modal" data-bs-target="#gameSelectorModal">
                            <div class="d-flex align-items-center">
                                <div class="game-setting-icon"><i class="bi bi-lightning-fill"></i></div>
                                <div>
                                    <div style="font-size: 12px; color: #888;">–í—ã–±—Ä–∞—Ç—å –∏–≥—Ä—É</div>
                                    <div style="font-weight: 700; font-size: 16px;" id="selected-game-name">...</div>
                                </div>
                            </div>
                            <i class="bi bi-chevron-right text-muted"></i>
                        </div>
                        <button class="btn-start-floating" id="btn-start-game">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
                    </div>

                    <!-- –û–∂–∏–¥–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –ì–æ—Å—Ç—å) -->
                    <div id="guest-waiting-msg" class="text-center text-muted w-100"
                        style="margin-top: auto; display: none;">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <p>–û–∂–∏–¥–∞–Ω–∏–µ —Ö–æ—Å—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</p>
                        <button class="btn btn-sm btn-link text-danger text-decoration-none"
                            onclick="leaveRoom()">–ü–æ–∫–∏–Ω—É—Ç—å
                            –∫–æ–º–Ω–∞—Ç—É</button>
                    </div>
                </div>
            </div>

            <!-- 4. –≠–ö–†–ê–ù –ò–ì–†–´ (–û—á–∏—â–µ–Ω–Ω—ã–π) -->
            <div id="screen-game" class="screen">
                <!-- –ú—ã —É–±—Ä–∞–ª–∏ –æ—Ç—Å—é–¥–∞ content-wrapper –∏ —à–∞–ø–∫—É. 
             –¢–µ–ø–µ—Ä—å –∏–≥—Ä–∞ (whoami.js) —Å–∞–º–∞ —Å—Ç—Ä–æ–∏—Ç —Å–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω -->
                <div id="game-area"></div>

                <!-- –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –∏–≥—Ä–∞–º–∏, 
             –Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ JS -->
                <div id="score-card" class="card mt-3 p-2" style="display:none;">
                    <h6 class="text-muted small ps-3 pt-2 mb-1">–†–µ–∑—É–ª—å—Ç–∞—Ç</h6>
                    <ul class="list-group list-group-flush" id="game-players-list"></ul>
                </div>
                <div id="game-host-controls" class="fixed-bottom p-3 bg-white border-top rounded-top-4 shadow-lg"
                    style="display:none; z-index: 2000;"></div>
            </div>

            <div id="screen-profile-edit" class="screen">
                <div class="room-content-wrapper">
                    <div class="d-flex align-items-center mb-4">
                        <button class="btn-back me-3" onclick="closeProfileEditor()">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <h4 class="fw-bold m-0">–†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ—Ñ–∏–ª—è</h4>
                    </div>

                    <div class="d-flex justify-content-center mb-4" id="avatar-preview-area">
                        <!-- Preview injected here -->
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">–ò–º—è</label>
                        <input type="text" class="form-control rounded-4 py-3 bg-light border-0" id="profile-name-input"
                            placeholder="–í–∞—à–µ –∏–º—è">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</label>
                        <div class="d-flex gap-3 mb-3">
                            <input type="text" class="form-control rounded-4 py-3 bg-light border-0 text-center"
                                id="emoji-input" placeholder="üòé" maxlength="2"
                                style="font-size: 32px; width: 80px; flex-shrink: 0;">
                            <button class="btn btn-light rounded-4 py-3 flex-grow-1 fw-bold"
                                onclick="document.getElementById('avatar-file-input').click()">
                                <i class="bi bi-image me-2"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                            </button>
                            <input type="file" id="avatar-file-input" accept="image/*" style="display: none;"
                                onchange="handleAvatarUpload(event)">
                        </div>
                        <label class="form-label fw-bold">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                        <div class="color-grid bg-light rounded-4" id="color-grid"></div>
                    </div>

                    <button class="btn btn-primary w-100 py-3 rounded-4 fw-bold mt-2"
                        style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%); border: none;"
                        onclick="saveProfile()">
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button class="btn btn-link w-100 mt-2 text-muted text-decoration-none"
                        onclick="pendingAvatar=null; updatePreview();">
                        –°–±—Ä–æ—Å–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
                    </button>
                </div>
            </div>

            <!-- 6. –≠–ö–†–ê–ù –î–†–£–ó–ï–ô (–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π) -->
            <div id="screen-friends" class="screen">
                <div class="friends-view-wrapper">
                    <div class="d-flex align-items-center mb-4">
                        <button class="btn-back me-3" onclick="closeFriendsScreen()">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <h4 class="fw-bold m-0">–î—Ä—É–∑—å—è</h4>
                    </div>

                    <!-- Tabs -->
                    <div class="nav nav-pills nav-fill mb-3 bg-light rounded-pill p-1">
                        <div class="nav-item" style="cursor:pointer">
                            <a class="nav-link active rounded-pill" id="btn-friends-my"
                                onclick="switchFriendsTab('my')">–ú–æ–∏</a>
                        </div>
                        <div class="nav-item" style="cursor:pointer">
                            <a class="nav-link rounded-pill" id="btn-friends-requests"
                                onclick="switchFriendsTab('requests')">–ó–∞—è–≤–∫–∏ <span id="friends-req-count"
                                    class="badge bg-danger rounded-circle" style="display:none;">0</span></a>
                        </div>
                    </div>

                    <!-- Custom Tabs Content -->
                    <div class="friends-tab-content w-100">
                        <!-- My Friends Tab -->
                        <div id="tab-friends-my" class="friends-tab-pane active w-100" style="display: block;">
                            <!-- Search -->
                            <div class="input-group mb-3"
                                style="box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 16px;">
                                <input type="text" id="friends-search-input" class="form-control bg-light border-0"
                                    placeholder="üîç –ù–∞–π—Ç–∏ –¥—Ä—É–≥–∞ –ø–æ –∏–º–µ–Ω–∏..."
                                    style="border-top-left-radius: 16px; border-bottom-left-radius: 16px; padding: 12px;"
                                    oninput="debounceSearchFriends()">
                                <button class="btn btn-primary" onclick="searchFriendsAction()"
                                    style="border-top-right-radius: 16px; border-bottom-right-radius: 16px; padding-left: 20px; padding-right: 20px;">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>

                            <!-- Search Results -->
                            <div id="friends-search-results" class="mb-3" style="display:none;">
                                <h6 class="text-muted small">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h6>
                                <div id="friends-search-list"></div>
                                <hr>
                            </div>

                            <!-- Friends List -->
                            <div id="friends-list-container">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary spinner-border-sm"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Requests Tab -->
                        <div id="tab-friends-requests" class="friends-tab-pane w-100" style="display: none;">
                            <div id="friends-req-container">
                                <p class="text-center text-muted m-0 p-0">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- 8. –≠–ö–†–ê–ù –ù–ê–°–¢–†–û–ï–ö -->
            <div id="screen-settings" class="screen">
                <div class="room-content-wrapper">
                    <div class="d-flex align-items-center mb-4">
                        <button class="btn-back me-3" onclick="closeSettingsScreen()">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <h4 class="fw-bold m-0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
                    </div>

                    <!-- –ì—Ä—É–ø–ø–∞: –ò–ù–¢–ï–†–§–ï–ô–° -->
                    <div class="settings-group-title small text-muted text-uppercase px-3 mb-2">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div>
                    <div class="settings-group mb-4">
                        <div class="settings-item">
                            <div class="settings-label-wrap">
                                <div class="fw-bold">–ë–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–π</div>
                                <div class="text-muted small">–≠–∫–æ–Ω–æ–º–∏—Ç –∑–∞—Ä—è–¥ –∏ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É</div>
                            </div>
                            <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                    id="setting-noAnimations" onchange="toggleSetting('noAnimations', this.checked)">
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-label-wrap">
                                <div class="fw-bold">–≠–∫–æ–Ω–æ–º–Ω—ã–π —Ñ–æ–Ω</div>
                                <div class="text-muted small">–û—Ç–∫–ª—é—á–∞–µ—Ç –∂–∏–≤—ã–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã</div>
                            </div>
                            <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                    id="setting-simpleBg" onchange="toggleSetting('simpleBg', this.checked)">
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-label-wrap">
                                <div class="fw-bold">–ö—Ä—É–ø–Ω—ã–π —à—Ä–∏—Ñ—Ç</div>
                                <div class="text-muted small">–£–≤–µ–ª–∏—á–∏—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞</div>
                            </div>
                            <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                    id="setting-largeFont" onchange="toggleSetting('largeFont', this.checked)">
                            </div>
                        </div>
                    </div>

                    <!-- –ì—Ä—É–ø–ø–∞: –û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨ -->
                    <div class="settings-group-title small text-muted text-uppercase px-3 mb-2">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</div>
                    <div class="settings-group mb-4">
                        <div class="settings-item">
                            <div class="settings-label-wrap">
                                <div class="fw-bold">–¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ—Ç–¥–∞—á–∞</div>
                                <div class="text-muted small">–í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è—Ö</div>
                            </div>
                            <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                    id="setting-haptics" onchange="toggleSetting('haptics', this.checked)">
                            </div>
                        </div>
                    </div>

                    <!-- –ì—Ä—É–ø–ø–∞: –ü–†–ò–í–ê–¢–ù–û–°–¢–¨ -->
                    <div class="settings-group-title small text-muted text-uppercase px-3 mb-2">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</div>
                    <div class="settings-group mb-4">
                        <div class="settings-item">
                            <div class="settings-label-wrap">
                                <div class="fw-bold">–õ–∏–¥–µ—Ä–±–æ—Ä–¥</div>
                                <div class="text-muted small">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–π –ø—Ä–æ—Ñ–∏–ª—å –≤ —Ç–æ–ø–µ</div>
                            </div>
                            <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                    id="setting-privacyLeaderboard"
                                    onchange="toggleSetting('privacyLeaderboard', this.checked)">
                            </div>
                        </div>
                    </div>

                    <!-- –ì—Ä—É–ø–ø–∞: –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
                    <div class="settings-group-title small text-muted text-uppercase px-3 mb-2">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                    <div class="settings-group mb-4">
                        <div class="settings-item">
                            <div class="settings-label-wrap">
                                <div class="fw-bold">–ó–∞–ø—Ä–æ—Å—ã –∏ –≤—ã–∑–æ–≤—ã</div>
                                <div class="text-muted small">–î—Ä—É–∑—å—è –∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –≤ –∏–≥—Ä—É</div>
                            </div>
                            <div class="form-check form-switch p-0 m-0 d-flex align-items-center">
                                <input class="form-check-input settings-switch ms-auto" type="checkbox"
                                    id="setting-notificationsEnabled"
                                    onchange="toggleSetting('notificationsEnabled', this.checked)">
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-auto pb-4">
                        <div class="text-muted small opacity-50">Party Games v1.1.0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- === –ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø === -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('home')"><i
                    class="bi bi-house-door-fill"></i><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
            <button class="nav-item" onclick="switchTab('games')"><i
                    class="bi bi-grid-fill"></i><span>–ò–≥—Ä—ã</span></button>
            <button class="nav-item" onclick="switchTab('leaderboard')"><i
                    class="bi bi-bar-chart-fill"></i><span>–¢–æ–ø</span></button>
            <button class="nav-item" onclick="switchTab('profile')"><i
                    class="bi bi-person-fill"></i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
        </div>

        <!-- === –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê === -->

        <!-- 1. –ú–æ–¥–∞–ª–∫–∞ –í—Ö–æ–¥–∞ -->
        <div class="modal fade" id="joinModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold ps-2">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body pt-2">
                        <input type="text" id="join-room-code"
                            class="form-control form-control-lg text-center text-uppercase mb-3 fw-bold"
                            placeholder="A1B2" maxlength="4"
                            style="border-radius: 16px; height: 60px; font-size: 24px; letter-spacing: 2px;">
                        <input type="password" id="join-room-pass" class="form-control mb-3"
                            placeholder="–ü–∞—Ä–æ–ª—å –∫–æ–º–Ω–∞—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="border-radius: 16px;">
                        <button class="btn btn-primary w-100 btn-lg" style="border-radius: 16px;"
                            onclick="joinRoom(); bootstrap.Modal.getInstance(document.getElementById('joinModal')).hide();">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. –ú–æ–¥–∞–ª–∫–∞ –°–æ–∑–¥–∞–Ω–∏—è -->
        <div class="modal fade" id="createModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold ps-2">–ù–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body pt-2">
                        <input type="text" id="create-room-title" class="form-control mb-3 fw-bold"
                            placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" style="border-radius: 16px;">

                        <input type="password" id="create-room-pass" class="form-control mb-3"
                            placeholder="–ü–∞—Ä–æ–ª—å –∫–æ–º–Ω–∞—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="border-radius: 16px;">

                        <div class="form-check form-switch mb-3 ps-5">
                            <input class="form-check-input" type="checkbox" id="create-room-public"
                                style="transform: scale(1.3);">
                            <label class="form-check-label ms-2 fw-bold" for="create-room-public">–°–¥–µ–ª–∞—Ç—å
                                –ø—É–±–ª–∏—á–Ω–æ–π</label>
                        </div>

                        <button class="btn btn-primary w-100 btn-lg" style="border-radius: 16px;"
                            onclick="createRoom(); bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();">–°–æ–∑–¥–∞—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. –ú–æ–¥–∞–ª–∫–∞ QR-–∫–æ–¥–∞ -->
        <div class="modal fade" id="qrInviteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg" style="border-radius: 32px; padding: 20px;">
                    <div class="d-flex justify-content-center mb-2">
                        <div style="width: 40px; height: 4px; background: #E0E0E0; border-radius: 2px;"></div>
                    </div>
                    <div class="text-center">
                        <h5 class="fw-bold mb-4" style="color: var(--text-dark);">–ö–æ–º–Ω–∞—Ç–∞ <span
                                id="modal-room-code-title">...</span></h5>
                        <div class="d-flex justify-content-center mb-3">
                            <div id="modal-qr-code"
                                style="padding: 10px; border-radius: 20px; border: 2px solid #F0F0F0;">
                            </div>
                        </div>
                        <h2 class="fw-bold mb-4"
                            style="font-size: 32px; color: var(--primary-color); letter-spacing: 1px;"
                            id="modal-room-code-text">...</h2>
                        <div class="d-grid gap-3">
                            <button class="btn btn-primary py-3 rounded-4 fw-bold shadow-sm"
                                style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%); border: none; font-size: 18px;"
                                onclick="copyInviteLink()">
                                <i class="bi bi-link-45deg me-2"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                            </button>
                            <button class="btn py-3 rounded-4 fw-bold shadow-sm"
                                style="background: #24A1DE; color: white; border: none; font-size: 18px;"
                                onclick="sendToTelegram()">
                                <i class="bi bi-telegram me-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç
                            </button>
                            <button class="btn py-3 rounded-4 fw-bold shadow-sm"
                                style="background: #fff; color: var(--primary-color); border: 1px solid #eee; font-size: 18px;"
                                onclick="bootstrap.Modal.getInstance(document.getElementById('qrInviteModal')).hide(); openInviteModal()">
                                <i class="bi bi-person-plus-fill me-2"></i> –ü–æ–∑–≤–∞—Ç—å –¥—Ä—É–≥–∞
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. –ú–æ–¥–∞–ª–∫–∞ –í—ã–±–æ—Ä–∞ –∏–≥—Ä—ã -->
        <div class="modal fade" id="gameSelectorModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                    <div class="modal-header border-0">
                        <h5 class="modal-title fw-bold ps-2">–í—ã–±—Ä–∞—Ç—å –∏–≥—Ä—É</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="list-group list-group-flush" id="game-selector-list"></div>
                    </div>
                </div>
            </div>
        </div>



        <!-- 4. –ú–æ–¥–∞–ª–∫–∞ –ü—É–±–ª–∏—á–Ω–æ–≥–æ –ü—Ä–æ—Ñ–∏–ª—è (–û–¥–Ω–æ–≥–æ —Å—Ç–∏–ª—è —Å –º–æ–¥–∞–ª–∫–æ–π –¥—Ä—É–∑–µ–π) -->
        <div class="modal fade" id="userProfileModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                    <div class="modal-header border-0 pb-0">
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center pt-0 pb-4">
                        <div id="public-profile-content">
                            <!-- JS injected content -->
                            <div class="spinner-border text-primary"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. –≠–ö–†–ê–ù –†–ï–î–ê–ö–¢–û–†–ê –ü–†–û–§–ò–õ–Ø (–û—Ç–¥–µ–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω) -->


    </div> <!-- /container -->
    </div> <!-- /device-content -->
    </div> <!-- /device-wrapper -->

    <!-- MOVED MODALS TO ROOT for correct z-index stacking -->
    <!-- 8. –ú–æ–¥–∞–ª–∫–∞ –ü—É–±–ª–∏—á–Ω–æ–≥–æ –ü—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal fade" id="leaderboardModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold ps-2">–¢–æ–ø –ò–≥—Ä–æ–∫–æ–≤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-2">
                    <ul class="nav nav-pills nav-fill mb-3 bg-light rounded-pill p-1">
                        <li class="nav-item">
                            <a class="nav-link active rounded-pill" data-bs-toggle="pill" href="#tab-lb-global"
                                onclick="loadLeaderboard('global')">–ì–ª–æ–±–∞–ª—å–Ω—ã–π</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link rounded-pill" data-bs-toggle="pill" href="#tab-lb-friends"
                                onclick="loadLeaderboard('friends')">–î—Ä—É–∑—å—è</a>
                        </li>
                    </ul>

                    <div id="leaderboard-container">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 9. –ú–æ–¥–∞–ª–∫–∞ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –î—Ä—É–∑–µ–π -->
    <div class="modal fade" id="inviteFriendsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow" style="border-radius: 24px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold ps-2">–ü–æ–∑–≤–∞—Ç—å –¥—Ä—É–∑–µ–π</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-2">
                    <div class="text-center mb-3">
                        <div class="invite-icon-wrapper">
                            <i class="bi bi-envelope-paper-heart-fill invite-icon"></i>
                        </div>
                        <p class="text-muted small">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥—Ä—É–∑—å—è–º,<br>—á—Ç–æ–±—ã –æ–Ω–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫
                            –∏–≥—Ä–µ.
                        </p>
                    </div>

                    <!-- Search -->
                    <div class="invite-search-group mb-3">
                        <div class="invite-search-icon"><i class="bi bi-search"></i></div>
                        <input type="text" id="invite-search-input" class="invite-search-input"
                            placeholder="–ü–æ–∏—Å–∫ –¥—Ä—É–≥–∞..." oninput="filterInviteList()">
                    </div>

                    <!-- List -->
                    <div id="invite-friends-list" class="mb-3 custom-scrollbar"
                        style="max-height: 300px; overflow-y: auto; overflow-x: hidden;">
                        <div class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer invite-modal-footer">
                    <button class="invite-send-btn link-light" onclick="sendInvites()" id="btn-send-invites" disabled>
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å (<span id="invite-count">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="libs/bootstrap.bundle.min.js"></script>
    <script>
        // Callback for the widget
        async function onTelegramAuth(user) {
            document.getElementById('browser-login-btn').style.display = 'none';
            document.getElementById('login-loading').style.display = 'block';
            const formData = new FormData();
            formData.append('action', 'login_widget');
            formData.append('user_data', JSON.stringify(user));
            try {
                const res = await fetch('server/api.php', { method: 'POST', body: formData }).then(r => r.json());
                if (res.status === 'ok') {
                    localStorage.setItem('pg_token', res.token);
                    window.location.reload();
                } else {
                    alert('Error: ' + res.message);
                    document.getElementById('browser-login-btn').style.display = 'block';
                }
            } catch (e) {
                console.error(e);
                alert('Network Error');
            }
        }

        async function loginViaBot() {
            try {
                const res = await fetch('server/api.php', {
                    method: 'POST',
                    body: new URLSearchParams({ action: 'create_auth_session' })
                }).then(r => r.json());

                if (res.status === 'ok') {
                    window.open(res.bot_url, '_blank');

                    // Start polling
                    const poll = setInterval(async () => {
                        const check = await fetch('server/api.php', {
                            method: 'POST',
                            body: new URLSearchParams({
                                action: 'poll_auth_session',
                                temp_code: res.temp_code
                            })
                        }).then(r => r.json());

                        if (check.status === 'ok') {
                            clearInterval(poll);
                            localStorage.setItem('pg_token', check.token);
                            window.location.reload();
                        }
                    }, 2000);

                    // Stop polling after 5 mins
                    setTimeout(() => clearInterval(poll), 300000);

                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏');
                }
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>

</html>